<html lang="">
<script>
    class GameObject {
        constructor(x, y) {
            this.x = x;
            this.y = y;

        }

        update() {
        }

        draw(graphics) {
        }
    }

    class Player extends GameObject {
        constructor(costume) {
            super(100, 250);
            this.costume = costume;
            this.animations = [];
            this.currentAnimation = null;
            this.currentFrame = 0;
            this.animationRate = 0.2;
            this.direction = 0;
            this.speedX = 0;
            this.speedY = 0;
        }

        update() {
            let walking = false;
            if (pressedKeys['a']) {
                this.x -= 10;
                walking = true
                this.direction = -1;
            }
            if (pressedKeys['d']) {
                this.x += 10;
                walking = true
                this.direction = 1;
            }
            if (walking)
                this.startAnimation("Walk")
            else
                this.startAnimation("Idle")

        }

        draw(graphics) {
            if (this.currentAnimation !== null) {
                this.currentFrame += this.animationRate
                if (Math.floor (this.currentFrame) >= this.animations[this.currentAnimation].length) {
                    this.currentFrame = 0;
                }
                graphics.save()
                graphics.scale(this.direction,1)
                const frame = this.animations[this.currentAnimation][Math.floor(this.currentFrame)];
                graphics.drawImage(frame, (this.x)*this.direction-0.5*frame.width, this.y-0.5*frame.height);
                graphics.restore()
            } else {
                graphics.drawImage(this.costume, this.x, this.y);
            }
        }

        addSprite(filename,animationName){
            const img= new Image();
            img.src = filename;
            if(this.animations[animationName] == null){
                this.animations[animationName] = [];
            }
            this.animations[animationName].push(img);

        }

        startAnimation(name) {
            this.currentAnimation = name;
        }

    }

    class Level extends GameObject {
        constructor(x, y, costume, zoom=1) {
            super(x,y);
            this.zoom = zoom;
            this.costume = costume;
        }

        draw(graphics) {
            graphics.save();
            graphics.transform(this.zoom,0,0, this.zoom,0,0);
            graphics.drawImage(this.costume, this.x, this.y);
            graphics.restore();
        }
    }

    class LightSource extends GameObject {
        constructor(follow, color = '#605451') {
            super(follow.x,follow.y);
            this.follow = follow;
            this.img = null;
            this.color = color;
        }


        update() {
            this.x=this.follow.x;
            this.y=this.follow.y;

        }
        draw(graphics) {
            graphics.save();
            graphics.globalCompositeOperation="screen";
            if (this.img==null) {
                const gradient=graphics.createRadialGradient(this.x,this.y, 300,this.x,this.y,0);
                gradient.addColorStop(0,'#000000');
                //  gradient.addColorStop(0.9,'#6c6464');
                gradient.addColorStop(1,this.color);
                graphics.fillStyle=gradient;
                graphics.fillRect(-10000,-10000,100000,100000);
            }
            else {
                graphics.drawImage(this.img,this.x,this.y);
            }
            graphics.restore();

        }
    }

    class Layer {
        constructor(distance) {
        this.distance=distance;
        this.gameObjects = [];
    }
        draw(graphics,camera) {
            graphics.save();
            graphics.transform(1/this.distance,0,0,1/this.distance,0,0);
            graphics.filter="blur("+this.distance+"px)";
           // graphics.scale(1/this.distance,1/this.distance);
            for (let i = 0; i < this.gameObjects.length; i++) {
                camera.drawObj(this.gameObjects[i]);
            }
            graphics.restore();
        }
        addGameObject(gameObject) {
            this.gameObjects.push(gameObject);
        }
    }

    class Camera {
        constructor(follow, graphics) {
            this.x = follow.x;
            this.y = follow.y;
            this.follow = follow;
            this.graphics = graphics;
        }

        update() {
            this.x = this.follow.x - canvas.width / 2;
            this.y = this.follow.y - canvas.height / 2;
        }

        drawObj(object) {
            graphics.save();
            graphics.translate(-this.x, -this.y);
            object.draw(this.graphics);
            graphics.restore();
        }
    }

    let pressedKeys = {};

    function keyPressed(event) {
        console.log("hej");
        pressedKeys[event.key] = true;
    }

    function keyReleased(event) {
        pressedKeys[event.key] = false;
    }

    window.onkeydown = keyPressed;
    window.onkeyup = keyReleased;
</script>
<body>
<canvas id="Game" width="1690" height="940"></canvas>
<script>
    const floorimage = new Image();
    floorimage.src = "B_Floor1_P1.png"
    const canvas = document.getElementById("Game");
    const graphics = canvas.getContext("2d");
    const playerimage = new Image();
    playerimage.src = "kasmiy9dahb7.png"
    const player = new Player(playerimage);
    player.addSprite("Walk1.png","Walk");
    player.addSprite("Walk2.png","Walk");
    player.addSprite("Walk3.png","Walk");
    player.addSprite("Walk4.png","Walk");
    player.addSprite("Idle1.png","Idle");
    player.addSprite("Idle1.png","Idle");
    player.addSprite("Idle1.png","Idle");
    player.addSprite("Idle2.png","Idle");
    player.addSprite("Idle2.png","Idle");
    player.addSprite("Idle2.png","Idle");
    player.startAnimation("Idle")
    const playerLight= new LightSource(player);


    const obj1img= new Image();
    obj1img.src = "Obj1.png";
    const obj2img= new Image();
    obj2img.src = "Obj2.png";
    const obj3img= new Image();
    obj3img.src = "Obj3.png";
    const obj4img= new Image();
    obj4img.src = "Obj4.png";
    const obj5img= new Image();
    obj5img.src = "Obj5.png";
    const fog= new Image();
    fog.src = "Fog3.png";
    const BG= new Image();
    BG.src = "Background.png";


    const layer1 = new Layer(1);
    layer1.addGameObject(new Level(200, 300, floorimage));
    const l1 = new Level(400, 300, floorimage);

    layer1.addGameObject(l1);
    //layer1.addGameObject(new LightSource(l1));
    //layer1.addGameObject(new LightSource(l1,fog));

    const layer2 = new Layer(2);
    layer2.addGameObject(new Level(200, -100, obj3img));
    layer2.addGameObject(new Level(600, 10, obj4img));

    const layer3 = new Layer(3);
    layer3.addGameObject(new Level(0, -50, BG,6));

    const layer4 = new Layer(4);
    layer4.addGameObject(new Level(200, -100, obj2img));
    const redLight = new Level(3000, 2700, obj1img);
    layer4.addGameObject(redLight);

    const camera = new Camera(player, graphics);
    let lastTime = 0;

    function control_Loop(time) {
        window.requestAnimationFrame(control_Loop);
        const duration = time - lastTime;
        if (duration < 1000 / 60) return;
        lastTime = time;
        graphics.clearRect(0, 0, canvas.width, canvas.height);
        player.update();
        playerLight.update();
        camera.update();
        layer4.draw(graphics,camera);
        layer3.draw(graphics,camera);
        layer2.draw(graphics,camera);
        layer1.draw(graphics,camera);
        camera.drawObj(player);
        camera.drawObj(playerLight);




    }

    control_Loop();

</script>
</body>
</html>