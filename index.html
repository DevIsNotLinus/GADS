<html lang="">
<script>
    class GameObject {
        constructor(x, y) {
            this.x = x;
            this.y = y;

        }

        update() {
        }

        draw(graphics) {
        }
    }

    class Player extends GameObject {
        constructor(costume) {
            super(100, 250);
            this.costume = costume;
            this.animations = [];
            this.currentAnimation = null;
            this.currentFrame = 0;
            this.animationRate = 0.2;
            this.direction = 0;
            this.speedX = 0;
            this.speedY = 0;
        }
        collision() {
            return this.y > 500;
        }

        update() {
            let walking = false;
            if (pressedKeys['a']) {
                if (this.collision())
                   this.speedX -= 15;
                walking = true
                this.direction = -1;
            }
            if (pressedKeys['d']) {
                if (this.collision())
                    this.speedX += 15;
                walking = true
                this.direction = 1;
            }
            if (pressedKeys[' '] && this.collision()) {
                this.speedX += 15*Math.sign(this.speedX);
                this.speedY -= 40;
                walking = true
            }
            this.x += this.speedX;
            this.y += this.speedY;
            // Air resistance
            this.speedX -= this.speedX*0.01;
            this.speedY -= this.speedY*0.01;

            // Friction
            if(this.collision()) {
                this.speedX -= Math.sign(this.speedX) * (this.speedX * this.speedX * 0.01);
            }

            // Gravity
            if (this.collision())
                this.speedY = 0;
            else
                this.speedY += 1.5;
            if (walking)
                this.startAnimation("Walk")
            else
                this.startAnimation("Idle")

        }

        draw(graphics) {
            if (this.currentAnimation !== null) {
                this.currentFrame += this.animationRate
                if (Math.floor (this.currentFrame) >= this.animations[this.currentAnimation].length) {
                    this.currentFrame = 0;
                }
                graphics.save()
                graphics.scale(this.direction,1)
                const frame = this.animations[this.currentAnimation][Math.floor(this.currentFrame)];
                graphics.drawImage(frame, (this.x)*this.direction-0.5*frame.width, this.y-0.5*frame.height);
                graphics.restore()
            } else {
                graphics.drawImage(this.costume, this.x, this.y);
            }
        }

        addSprite(filename,animationName){
            const img= new Image();
            img.src = filename;
            if(this.animations[animationName] == null){
                this.animations[animationName] = [];
            }
            this.animations[animationName].push(img);

        }

        startAnimation(name) {
            this.currentAnimation = name;
        }

    }

    class Level extends GameObject {
        constructor(x, y, costume, zoom=1) {
            super(x,y);
            this.zoom = zoom;
            this.costume = costume;
        }

        draw(graphics) {
           // graphics.save();
          //  graphics.transform(this.zoom,0,0, this.zoom,0,0);
            graphics.drawImage(this.costume, this.x - this.costume.width/2, this.y + this.costume.height/2, this.costume.width*this.zoom, this.costume.height*this.zoom );
           // graphics.restore();
        }
    }

    class LightSource extends GameObject {
        constructor(follow, color = '#605451') {
            super(follow.x,follow.y);
            this.follow = follow;
            this.img = null;
            this.color = color;
        }


        update() {
            this.x=this.follow.x;
            this.y=this.follow.y;

        }
        draw(graphics) {
            graphics.save();
            graphics.globalCompositeOperation="screen";
            if (this.img==null) {
                const gradient=graphics.createRadialGradient(this.x,this.y, 300,this.x,this.y,0);
                gradient.addColorStop(0,'#000000');
                //  gradient.addColorStop(0.9,'#6c6464');
                gradient.addColorStop(1,this.color);
                graphics.fillStyle=gradient;
                graphics.fillRect(-10000,-10000,100000,100000);
            }
            else {
                graphics.drawImage(this.img,this.x,this.y);
            }
            graphics.restore();

        }
    }

    class Layer {
        constructor(distance) {
        this.distance=distance;
        this.gameObjects = [];
    }
        draw(graphics,camera) {
            graphics.save();
            graphics.transform(1/this.distance,0,0,1/this.distance,0,0);
            graphics.filter="blur("+this.distance+"px)";
           // graphics.scale(1/this.distance,1/this.distance);
            for (let i = 0; i < this.gameObjects.length; i++) {
                camera.drawObj(this.gameObjects[i]);
            }
            graphics.restore();
        }
        addGameObject(gameObject) {
            this.gameObjects.push(gameObject);
        }
    }

    class Camera {
        constructor(follow, graphics) {
            this.x = follow.x;
            this.y = follow.y;
            this.follow = follow;
            this.graphics = graphics;
        }

        update() {
            this.x = this.follow.x - canvas.width / 2;
            this.y = this.follow.y - canvas.height / 2;
            if(this.y > 300 - canvas.height / 2)
                this.y = 300 - canvas.height / 2;
        }

        drawObj(object) {
            graphics.save();
            graphics.translate(-this.x, -this.y);
            object.draw(this.graphics);
            graphics.restore();
        }
    }

    let pressedKeys = {};

    function keyPressed(event) {
        console.log("hej");
        pressedKeys[event.key] = true;
    }

    function keyReleased(event) {
        pressedKeys[event.key] = false;
    }

    window.onkeydown = keyPressed;
    window.onkeyup = keyReleased;
</script>
<body>
<canvas id="Game" width="1690" height="940"></canvas>
<script>
    const floorimage = new Image();
    floorimage.src = "assets/B_Floor1_P1.png"
    const canvas = document.getElementById("Game");
    const graphics = canvas.getContext("2d");
    const playerimage = new Image();
    playerimage.src = "assets/kasmiy9dahb7.png"
    const player = new Player(playerimage);
    player.addSprite("assets/Walk1.png","Walk");
    player.addSprite("assets/Walk2.png","Walk");
    player.addSprite("assets/Walk3.png","Walk");
    player.addSprite("assets/Walk4.png","Walk");
    player.addSprite("assets/Idle1.png","Idle");
    player.addSprite("assets/Idle1.png","Idle");
    player.addSprite("assets/Idle1.png","Idle");
    player.addSprite("assets/Idle2.png","Idle");
    player.addSprite("assets/Idle2.png","Idle");
    player.addSprite("assets/Idle2.png","Idle");
    player.startAnimation("Idle")
    const playerLight= new LightSource(player);


    const obj1img= new Image();
    obj1img.src = "assets/Obj1.png";
    const obj2img= new Image();
    obj2img.src = "assets/Obj2.png";
    const obj3img= new Image();
    obj3img.src = "assets/Obj3.png";
    const obj4img= new Image();
    obj4img.src = "assets/Obj4.png";
    const obj5img= new Image();
    obj5img.src = "assets/Obj5.png";
    const fog= new Image();
    fog.src = "assets/Fog3.png";
    const BG= new Image();
    BG.src = "assets/Background.png";
    const lampPost = new Image();
    lampPost.src = "assets/Lamppost1.png";
    const stoneFloor = new Image();
    stoneFloor.src = "assets/StonedFloor.png";

    const playerLayer = new Layer(1);
    playerLayer.addGameObject(new Level(200, 300, floorimage));
    const l1 = new Level(400, 300, floorimage);
    playerLayer.addGameObject(l1);
    //playerLayer.addGameObject(new LightSource(l1));
    //playerLayer.addGameObject(new LightSource(l1,fog));
    playerLayer.addGameObject(new Level(100,0 , lampPost, 2));
    for( var i=0; i<10; i++){
        playerLayer.addGameObject(new Level(i*860, 590, stoneFloor, 1.8));
    }


    const nearBackgroundLayer = new Layer(2);
    nearBackgroundLayer.addGameObject(new Level(200, -100, obj3img));
    nearBackgroundLayer.addGameObject(new Level(600, 10, obj4img));

    const middleBackgroundLayer = new Layer(3);
    middleBackgroundLayer.addGameObject(new Level(0, -1540, BG,6));

    const farBackgroundLayer = new Layer(4);
    farBackgroundLayer.addGameObject(new Level(200, -100, obj2img));
    const redLight = new Level(3000, 2700, obj1img);
    farBackgroundLayer.addGameObject(redLight);

    const camera = new Camera(player, graphics);
    let lastTime = 0;

    function control_Loop(time) {
        window.requestAnimationFrame(control_Loop);
        const duration = time - lastTime;
        if (duration < 1000 / 60) return;
        lastTime = time;
        graphics.clearRect(0, 0, canvas.width, canvas.height);
        player.update();
        playerLight.update();
        camera.update();
        farBackgroundLayer.draw(graphics,camera);
        middleBackgroundLayer.draw(graphics,camera);
        nearBackgroundLayer.draw(graphics,camera);
        playerLayer.draw(graphics,camera);
        camera.drawObj(player);
        camera.drawObj(playerLight);




    }

    control_Loop();

</script>

</body>

</html>



